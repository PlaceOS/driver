name: CI
on: push
jobs:
  style:
      runs-on: ubuntu-latest
      steps:
        - name: Install Crystal
          uses: oprypin/install-crystal@v1
        - name: Check out repository code
          uses: actions/checkout@v2
        - name: Format
          run: crystal tool format --check
        - name: Lint
          uses: crystal-ameba/github-action@v0.2.12
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  test:
      strategy:
        fail-fast: false
        matrix:
          os: [ubuntu-latest]
          crystal: [latest, nightly]
      runs-on: ${{ matrix.os }}
      steps:
        - name: Install Crystal
          uses: oprypin/install-crystal@v1
          with:
            crystal: ${{ matrix.crystal }}
        - name: Install the latest version of LibSSH2
          run: |
            wget https://launchpad.net/ubuntu/+source/libgcrypt20/1.8.3-1ubuntu1/+build/15106861/+files/libgcrypt20-dev_1.8.3-1ubuntu1_amd64.deb
            wget https://launchpad.net/ubuntu/+source/libgcrypt20/1.8.3-1ubuntu1/+build/15106861/+files/libgcrypt20_1.8.3-1ubuntu1_amd64.deb
            wget https://launchpad.net/ubuntu/+source/libgpg-error/1.32-1/+build/15118612/+files/libgpg-error-dev_1.32-1_amd64.deb
            wget https://launchpad.net/ubuntu/+source/libgpg-error/1.32-1/+build/15118612/+files/libgpg-error0_1.32-1_amd64.deb
            wget https://launchpad.net/ubuntu/+source/libssh2/1.8.0-2/+build/15151524/+files/libssh2-1-dev_1.8.0-2_amd64.deb
            wget https://launchpad.net/ubuntu/+source/libssh2/1.8.0-2/+build/15151524/+files/libssh2-1_1.8.0-2_amd64.deb
            sudo dpkg -i libgpg-error0_1.32-1_amd64.deb
            sudo dpkg -i libgcrypt20_1.8.3-1ubuntu1_amd64.deb
            sudo dpkg -i libssh2-1_1.8.0-2_amd64.deb
            sudo dpkg -i libgpg-error-dev_1.32-1_amd64.deb
            sudo dpkg -i libgcrypt20-dev_1.8.3-1ubuntu1_amd64.deb
            sudo dpkg -i libssh2-1-dev_1.8.0-2_amd64.deb
        - name: Install Redis
          run: docker run -d -p 6379:6379 redis:6-alpine
        - name: Check out repository code
          uses: actions/checkout@v2
        - name: Install dependencies
          run: shards install --ignore-crystal-version
        - name: Run tests
          run: crystal spec -v --error-trace
